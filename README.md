# 共創カフェ 統合シフト・勤怠管理システム

山形大学 共創カフェのシフト提出・打刻・管理システムです。

## 目次

1. [システム概要](#システム概要)
2. [システムフロー](#システムフロー)
3. [ファイル構造](#ファイル構造)
4. [機能一覧](#機能一覧)
5. [セットアップ手順](#セットアップ手順)
6. [システム設定](#システム設定)
7. [サブエージェント・スキル](#サブエージェントスキル)
8. [更新・メンテナンス手順](#更新メンテナンス手順)
9. [トラブルシューティング](#トラブルシューティング)
10. [技術仕様](#技術仕様)

---

## システム概要

### アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    ブラウザ（クライアント）                  │
├─────────────────────────────────────────────────────────────┤
│  index.html   │  clock.html   │  calendar.html  │  admin.html │
│  (シフト提出)  │    (打刻)     │   (カレンダー)   │   (管理)    │
└───────┬───────────────┬───────────────┬───────────────┬─────┘
        │               │               │               │
        └───────────────┴───────────────┴───────────────┘
                                │
                    ┌───────────▼───────────┐
                    │  JavaScript (js/)     │
                    │  config.js / utils.js │
                    │  submit.js / clock.js │
                    │  calendar.js / admin.js│
                    └───────────┬───────────┘
                                │ JSON API
                    ┌───────────▼───────────┐
                    │  Google Apps Script   │
                    │    (gas/Code.gs)      │
                    │      API v1.1         │
                    └───────────┬───────────┘
                                │
                    ┌───────────▼───────────┐
                    │  Google スプレッドシート │
                    │  - シフト提出シート    │
                    │  - 打刻履歴シート      │
                    │  - シフト枠設定シート  │
                    └───────────────────────┘
```

### 主な特徴

- **週1制約**: 1週間に1つだけシフト登録可能（90分/枠）
- **シフト枠制**: 管理者が日付ごとにシフト枠を設定
- **遅刻・早退自動判定**: 打刻時に自動でステータスを記録
- **GAS連携**: Google スプレッドシートをデータベースとして使用
- **データベース一元管理**: 全端末で同じシフト枠設定を共有
- **CSV/Excel一括インポート**: シフト枠の一括登録に対応
- **GAS接続テスト**: 管理画面からデータベース接続を確認可能
- **レスポンシブ対応**: スマホ・タブレット・PCに対応

---

## システムフロー

### シフト枠登録から提出までの流れ

```
┌─────────────────┐
│ 1. 管理者       │
│   シフト枠を登録 │
│  (admin.html)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 2. GASに保存    │
│  スプレッドシート │
│ 「シフト枠設定」  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 3. カレンダー   │
│  シフト枠表示   │
│ (calendar.html) │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 4. ユーザー     │
│  シフトを提出   │
│  (index.html)   │
└─────────────────┘
```

### 詳細フロー

1. **管理者がシフト枠を登録**
   - `admin.html` → シフト設定タブ
   - 日付・枠名（必須）・開始/終了時刻・必要人数を入力
   - 「シフト枠を追加」ボタンで保存

2. **データベースに保存**
   - GAS API (`saveShiftSlot`) 経由でスプレッドシートに保存
   - 「シフト枠設定」シートにレコード追加

3. **カレンダーに表示**
   - `calendar.html` でシフト枠と申請状況を表示
   - 日付をクリックで詳細確認

4. **ユーザーがシフトを提出**
   - `index.html` で名前を選択
   - 登録されたシフト枠から希望枠を選択
   - 「シフトを提出」で申請完了

---

## ファイル構造

```
/
├── README.md                      # このファイル（システム説明書）
├── CLAUDE.md                      # Claude Code用プロジェクト設定
├── .claude/
│   └── commands/                  # サブエージェントスキル
│       ├── workflow.md            # ワークフロー管理 v5.0
│       ├── design.md              # デザインエージェント
│       ├── coding.md              # コーディングエージェント v5.0
│       ├── backend.md             # バックエンドエージェント v2.0
│       ├── gas-setup.md           # GASセットアップガイド
│       ├── image-gen.md           # 画像生成エージェント
│       ├── debug.md               # デバッグエージェント v6.0
│       ├── responsive.md          # レスポンシブ対応エージェント v1.0
│       ├── persona.md             # ペルソナ評価エージェント
│       └── evaluator.md           # 評価者エージェント v3.0
│
├── cafe-unified-system/           # メインシステム（統合版）
│   ├── index.html                 # シフト提出画面
│   ├── clock.html                 # 打刻画面
│   ├── calendar.html              # カレンダー画面
│   ├── admin.html                 # 管理画面
│   ├── SETUP.md                   # クイックセットアップガイド
│   ├── css/
│   │   └── style.css              # 統一スタイルシート（モバイルファースト）
│   ├── js/
│   │   ├── config.js              # 設定ファイル（GAS URL、スタッフリスト等）
│   │   ├── utils.js               # ユーティリティ関数
│   │   ├── submit.js              # シフト提出ロジック
│   │   ├── clock.js               # 打刻ロジック
│   │   ├── calendar.js            # カレンダー表示ロジック
│   │   └── admin.js               # 管理画面ロジック
│   └── gas/
│       └── Code.gs                # Google Apps Script APIコード v1.1
│
└── docs/                          # ドキュメント
```

---

## 機能一覧

### 1. シフト提出画面（index.html）

| 機能 | 説明 |
|------|------|
| スタッフ選択 | 検索フィルター付きドロップダウン |
| 週別シフト選択 | データベースに登録された枠を表示、週1枠のみ選択可能 |
| 他スタッフ状況表示 | 各枠の充足状況をバッジで表示 |
| シフト提出 | GAS + ローカルストレージに保存 |
| シフトキャンセル | モーダル確認後にキャンセル可能 |
| オンボーディング | 使い方ガイドを常時表示 |

### 2. 打刻画面（clock.html）

| 機能 | 説明 |
|------|------|
| リアルタイム時刻表示 | 1秒ごとに更新 |
| 本日のシフト表示 | 選択スタッフの本日シフトを表示 |
| シフト枠選択 | 打刻対象の枠を選択 |
| 出勤・退勤ボタン | 打刻を記録 |
| 遅刻・早退判定 | 開始5分後→遅刻、終了15分前→早退 |
| 二重打刻防止 | 同じ枠で重複打刻を防止 |
| 打刻履歴表示 | 本日の打刻履歴を表示 |
| 研修打刻テスト | テストモードで動作確認可能 |

### 3. カレンダー画面（calendar.html）

| 機能 | 説明 |
|------|------|
| 月別カレンダー表示 | シフト枠が登録された日を表示 |
| スタッフフィルター | 特定スタッフのシフトをハイライト |
| 枠充足状況 | 色分けで人員状況を表示 |
| シフト統計 | 総枠数、申請済み、人員不足、自分の枠 |
| 日付別詳細 | クリックで詳細表示 |

### 4. 管理画面（admin.html）

| タブ | 機能 |
|------|------|
| 勤怠一覧 | 日付・スタッフ別フィルター、CSV出力 |
| 週別確認 | 週1制約違反の検出 |
| シフト管理 | 日付別シフト状況確認、シフト取消 |
| シフト設定 | シフト枠の追加・削除・一括インポート・接続テスト |
| スタッフ | 登録スタッフ一覧・統計 |
| データ管理 | JSONエクスポート、データクリア |

#### シフト設定タブの機能

| 機能 | 説明 |
|------|------|
| シフト枠追加 | 日付・枠名（必須）・時間帯・必要人数を指定して追加 |
| シフト枠削除 | 不要な枠を削除 |
| CSV/Excel一括インポート | テンプレートを使用した一括登録 |
| GAS接続テスト | データベース接続状態を確認 |
| データ再読み込み | キャッシュをクリアして最新データを取得 |

---

## セットアップ手順

### ステップ1: Google スプレッドシート作成（5分）

1. **新規スプレッドシート作成**
   - https://sheets.google.com にアクセス
   - 「+ 空白」をクリック
   - ファイル名: 「共創カフェ シフト管理」

2. **Apps Script を開く**
   - メニュー「拡張機能」→「Apps Script」
   - プロジェクト名を設定（例: 「CafeAPI」）

3. **コードを貼り付け**
   - `cafe-unified-system/gas/Code.gs` の内容をコピー
   - エディタに貼り付け
   - 保存（Ctrl+S）

4. **初期化を実行**
   - ドロップダウンで `initializeSheets` を選択
   - 「実行」をクリック
   - 権限を許可（「詳細」→「プロジェクト名に移動」→「許可」）

5. **シート確認**
   - スプレッドシートに以下のシートが作成されていることを確認:
     - 「シフト提出」
     - 「打刻履歴」
     - 「シフト枠設定」

### ステップ2: ウェブアプリとしてデプロイ（3分）

1. **デプロイメニュー**
   - 右上「デプロイ」→「新しいデプロイ」

2. **設定**
   - 種類: ウェブアプリ
   - 説明: 「共創カフェAPI v1.1」
   - 次のユーザーとして実行: **自分**
   - アクセスできるユーザー: **全員**

3. **デプロイ実行**
   - 「デプロイ」をクリック
   - 表示された **ウェブアプリURL** をコピー

### ステップ3: config.js にURL設定（1分）

`cafe-unified-system/js/config.js` を編集:

```javascript
GAS_URL: {
    production: 'https://script.google.com/macros/s/XXXXX/exec',
    development: 'https://script.google.com/macros/s/XXXXX/exec'
},
```

### ステップ4: シフト枠を登録

1. **管理画面にログイン**
   - admin.htmlを開く
   - パスワード: `gakkan2025`

2. **シフト設定タブを開く**

3. **接続テストを実行**
   - 「接続テスト実行」ボタンをクリック
   - 「接続成功」と表示されることを確認

4. **シフト枠を追加**
   - 日付を選択
   - 枠名を入力（必須）
   - 開始/終了時刻を設定
   - 必要人数を設定
   - 「シフト枠を追加」をクリック

### ステップ5: GitHub Pages で公開（5分）

1. **GitHubリポジトリ作成**
   - リポジトリ名: `cafe-shift-system`

2. **ファイルをアップロード**
   - ルートのHTMLファイル、cafe-unified-systemフォルダをアップロード

3. **Pages設定**
   - Settings → Pages → Source: main branch
   - 公開URL: `https://ユーザー名.github.io/cafe-shift-system/`

### 動作確認

ブラウザで以下にアクセス:
```
https://script.google.com/macros/s/XXXXX/exec?action=status
```

正常なら以下が表示:
```json
{"success":true,"message":"Cafe Unified System API","version":"1.1"}
```

---

## システム設定

### config.js 主要設定

```javascript
const CONFIG = {
    // API設定
    GAS_URL: { ... },              // GASのURL
    ENV: 'development',            // 環境（production/development）
    DEMO_MODE: false,              // デモモード
    ADMIN_PASSWORD: 'gakkan2025',  // 管理画面パスワード

    // 週1制約
    WEEKLY_SHIFT_LIMIT: 1,

    // 各枠の必要人数（デフォルト）
    REQUIRED_STAFF_PER_SLOT: 3,

    // 打刻許容時間
    PUNCH_TOLERANCE: {
        early: 10,                 // 開始10分前から打刻可能
        late: 30                   // 開始30分後まで遅刻として記録
    },

    // スタッフリスト
    STAFF_LIST: [
        { id: '25011003', name: '小畑 璃海', role: 'staff' },
        { id: '25011754', name: '山﨑 琢己', role: 'admin' },
        // ...
    ],

    // 役割定義
    ROLES: {
        admin: { label: '管理者', color: '#DC2626' },
        leader: { label: 'リーダー', color: '#FF9800' },
        staff: { label: 'スタッフ', color: '#16a34a' }
    }
};
```

### シフト枠設定の仕組み

シフト枠設定は以下の優先順位で取得されます:

1. **GASデータベース（スプレッドシート）** - 最優先
2. **ローカルストレージ（キャッシュ）** - オフライン時のフォールバック

管理画面からシフト枠を追加・削除すると、GASデータベースに保存されます。
これにより、どの端末からでも同じシフト枠設定が表示されます。

---

## サブエージェント・スキル

Claude Codeで使用できる開発支援スキルです。

### スキル一覧

| コマンド | バージョン | 説明 |
|---------|-----------|------|
| `/workflow` | v5.0 | 開発ワークフロー全体を統括 |
| `/design` | - | UI/UXデザイン設計 |
| `/coding` | v5.0 | フロントエンド実装 |
| `/backend` | v2.0 | GAS・サーバーサイド実装 |
| `/gas-setup` | - | GASセットアップガイド |
| `/image-gen` | - | 画像生成プロンプト作成 |
| `/debug` | v6.0 | バグ修正・動作確認 |
| `/responsive` | v1.0 | レスポンシブ・クロスブラウザ対応 |
| `/persona` | - | ペルソナ視点評価 |
| `/evaluator` | v3.0 | 超厳格品質評価 |
| `/ux-tester` | v1.0 | 初回ユーザー視点評価 |

---

## 更新・メンテナンス手順

### GASコード更新（重要）

**GASのコードを変更した場合、必ず新しいデプロイが必要です。**

1. **Apps Script を開く**
   - スプレッドシート → 拡張機能 → Apps Script

2. **コードを更新**
   - 変更を加えて保存

3. **新しいデプロイを作成**
   - 「デプロイ」→「**新しいデプロイ**」
   - 種類: ウェブアプリ
   - アクセス: 全員
   - 「デプロイ」をクリック

4. **config.jsを更新**
   - 新しいURLをコピー
   - `config.js` の `GAS_URL` を更新

**注意**: 「デプロイを管理」から既存のデプロイを編集しても反映されません。

### シフト枠の追加・変更

**管理画面から操作（データベースに保存）:**

1. 管理画面 → シフト設定タブ
2. 日付・枠名（必須）・時間帯・必要人数を入力
3. 「シフト枠を追加」をクリック

または、CSV/Excelで一括インポート:

1. テンプレートをダウンロード
2. シフト枠情報を入力
3. ファイルをアップロード
4. プレビュー確認後「一括登録」

### スタッフリスト更新

`cafe-unified-system/js/config.js` の `STAFF_LIST` を編集:

```javascript
STAFF_LIST: [
    { id: '学生番号', name: '名前', role: 'staff' },
    // role: 'admin'（管理者）, 'leader'（リーダー）, 'staff'（スタッフ）
]
```

### 管理画面パスワード変更

`config.js` を編集:
```javascript
ADMIN_PASSWORD: '新しいパスワード',
```

---

## トラブルシューティング

### よくある問題

#### データが保存されない

1. **GAS接続テストを実行**
   - 管理画面 → シフト設定 → 「接続テスト実行」

2. **GASの再デプロイ**
   - Apps Script → デプロイ → **新しいデプロイ**
   - 新しいURLを `config.js` に設定

3. **コンソールでエラー確認**
   - F12でDevTools開く
   - Consoleタブでエラーを確認

#### 「このアプリは確認されていません」と表示

- 「詳細」→「（安全ではないページ）に移動」で進む
- 自分のスクリプトなので問題なし

#### シフト枠が表示されない

1. **管理画面でシフト枠を登録する**
   - シフト設定タブで枠を追加

2. **接続テストで確認**
   - GASとの接続が正常か確認

3. **データ再読み込み**
   - 「データ再読み込み」ボタンをクリック

#### 週1制約で登録できない

- 同じ週に既にシフトが登録されている
- 既存のシフトをキャンセルしてから再登録

---

## 技術仕様

### GAS API エンドポイント

#### POST リクエスト

| アクション | 説明 | パラメータ |
|-----------|------|-----------|
| submitShifts | シフト提出（週1制約チェック） | submissions[] |
| deleteShift | シフト削除（ID指定） | shiftId |
| punch | 打刻記録 | staffId, date, slotId, type, time |
| getShifts | シフト取得 | staffId?, date?, weekKey? |
| getClockRecords | 打刻取得 | staffId?, date?, slotId? |
| getAllShifts | 全シフト取得 | - |
| getAllClockRecords | 全打刻取得 | - |
| checkViolations | 週1違反検出 | - |
| getStats | 統計情報取得 | - |
| getShiftSlotConfig | シフト枠設定取得 | - |
| saveShiftSlot | シフト枠保存 | dateStr, slot |
| deleteShiftSlotConfig | シフト枠削除 | dateStr, slotId? |
| importShiftSlots | シフト枠一括インポート | slots[] |

#### レスポンス形式

```json
{
    "success": true,
    "shifts": [...],
    "message": "処理完了"
}
```

### データベーススキーマ

#### シフト提出シート

| カラム | 説明 |
|--------|------|
| ID | ユニークID |
| スタッフID | 学生番号 |
| スタッフ名 | 名前 |
| 週キー | 週の識別子（月曜日の日付） |
| 日付 | YYYY-MM-DD形式 |
| シフト枠ID | SLOT_1, SLOT_2等 |
| シフト枠名 | 枠1, 枠2等 |
| 開始時刻 | HH:MM形式 |
| 終了時刻 | HH:MM形式 |
| 提出日時 | ISO形式 |

#### 打刻履歴シート

| カラム | 説明 |
|--------|------|
| ID | ユニークID |
| スタッフID | 学生番号 |
| スタッフ名 | 名前 |
| 日付 | YYYY-MM-DD形式 |
| シフト枠ID | SLOT_1, SLOT_2等 |
| シフト枠名 | 枠1, 枠2等 |
| 種別 | IN（出勤）/ OUT（退勤） |
| 時刻 | HH:MM:SS形式 |
| 状態 | normal / late / early_leave |
| タイムスタンプ | ISO形式 |

#### シフト枠設定シート

| カラム | 説明 |
|--------|------|
| ID | ユニークID |
| 日付 | YYYY-MM-DD形式 |
| 枠ID | SLOT_1, SLOT_2等 |
| 枠名 | 枠1, 午前枠等 |
| 開始時刻 | HH:MM形式 |
| 終了時刻 | HH:MM形式 |
| 必要人数 | 数値 |
| 作成日時 | ISO形式 |
| 更新日時 | ISO形式 |

### ローカルストレージキー

| キー | 説明 |
|------|------|
| cafe_unified_last_staff_id | 最後に選択したスタッフID |
| cafe_unified_auth | 管理画面認証トークン |
| cafe_unified_shifts | シフトデータキャッシュ |
| cafe_unified_clock | 打刻データキャッシュ |
| cafe_custom_shift_slots | シフト枠設定キャッシュ |

### CSSカラースキーム

| 用途 | カラーコード |
|------|-------------|
| プライマリ（緑） | #2E7D32 |
| セカンダリ（グレー） | #546E7A |
| 出勤（青） | #1976D2 |
| 退勤（オレンジ） | #E64A19 |
| エラー（赤） | #E53935 |
| 成功（緑） | #43A047 |

---

## ライセンス・クレジット

- 開発: 山形大学 共創カフェ
- 技術支援: Claude Code

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|----------|
| 2024-12-27 | 1.0 | 初版リリース |
| 2024-12-27 | 1.1 | UX改善（検索機能、オンボーディング、キャンセル機能） |
| 2024-12-27 | 1.2 | 打刻許容時間を10分前に変更、管理者役職追加 |
| 2026-01-19 | 2.0 | シフト枠設定のGASデータベース化、CSV/Excel一括インポート機能追加 |
| 2026-01-20 | 2.1 | GAS接続テスト機能追加、枠名必須化、営業期間表示削除 |
